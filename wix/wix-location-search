import wixData from 'wix-data';
import wixLocation from 'wix-location';
const Category = 'Finance & Insurance';
let filterByTitle;
let debounceTimer;

$w("#input9").onKeyPress(function () {

    if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = undefined;
    }
    debounceTimer = setTimeout(() => {
        filter($w('#input9').value);
        checkKeyword()
    }, 100);
});

function filter(tutorials) {
    if (filterByTitle !== tutorials) {
        let newFilter = wixData.filter();

        if (tutorials)
            newFilter = newFilter.contains('location__country', tutorials).and(wixData.filter().contains('categories__categoryId', Category));

        $w('#dataset1').setFilter(newFilter);

        filterByTitle = tutorials;
    }
}

//FILTER REPEATER WITH REPEATER ITEM
$w('#dynamicDataset').onReady(() => {
    $w('#repeater2').onItemReady(($item, itemData) => {

        //CREATE AN EMPTY ARRAY
        let arrKeyword = []

        $item('#button43').onClick(() => { //change button id

            $w('#repeater2').hide();

            //ADD THE ITEM'S TITLE TO THE ARRAY
            arrKeyword.push(itemData.location__country)

            console.log(arrKeyword)

            //FILTER DATASET WITH THE TITLE IN THE ARRAY
            $w('#dynamicDataset').setFilter(wixData.filter().hasAll('location__country', arrKeyword));

        });
    });
});

//SHOW THE REPEATER ONLY WHEN THE ITEM IS FOUND
function checkKeyword() {
    let searchKey = $w("#input9").value;

    wixData.query("Items") // dataset 2 name
        .contains("location__country", searchKey)
        .and(wixData.query("Items").contains('categories__categoryId', Category))
        .find()
        .then(result => {
            result.length > 0 ? $w("#repeater2").show() : $w("#repeater2").hide();
        });
}